{% extends "admin/base_site.html" %}
{% load i18n static %}

{% block extrahead %}
{{ block.super }}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
{% endblock %}

{% block content %}
<div class="dashboard-stats">
    <div class="stat-card">
        <h3>Total Cars</h3>
        <div class="number">{{ total_cars }}</div>
        <div class="description">Cars in inventory</div>
    </div>
    
    <div class="stat-card">
        <h3>Total Investments</h3>
        <div class="number">${{ total_investments|floatformat:0 }}</div>
        <div class="description">Total invested amount</div>
    </div>
    
    <div class="stat-card">
        <h3>Total Expenses</h3>
        <div class="number">${{ total_expenses|floatformat:0 }}</div>
        <div class="description">Total expenses recorded</div>
    </div>
    
    <div class="stat-card">
        <h3>Active Investors</h3>
        <div class="number">{{ active_investors }}</div>
        <div class="description">Users with investments</div>
    </div>
</div>

<div class="charts-grid" style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin: 20px 0;">
    <div class="stat-card">
        <h3>Investment Overview</h3>
        <div class="chart-container">
            <canvas id="investmentChart"></canvas>
        </div>
    </div>
    
    <div class="stat-card">
        <h3>Car Status Distribution</h3>
        <div class="chart-container">
            <canvas id="statusChart"></canvas>
        </div>
    </div>
</div>

{{ block.super }}

<script>
// Investment vs Expenses Chart
const investmentCtx = document.getElementById('investmentChart').getContext('2d');
new Chart(investmentCtx, {
    type: 'doughnut',
    data: {
        labels: ['Investments', 'Expenses'],
        datasets: [{
            data: [{{ total_investments }}, {{ total_expenses }}],
            backgroundColor: ['#667eea', '#f093fb'],
            borderWidth: 2,
            borderColor: '#fff'
        }]
    },
    options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
            legend: {
                position: 'bottom',
                labels: {
                    padding: 20,
                    font: {
                        size: 12
                    }
                }
            }
        },
        layout: {
            padding: 10
        }
    }
});

// Fetch and display car status chart
fetch('{% url "admin:dashboard_stats" %}')
    .then(response => response.json())
    .then(data => {
        const statusCtx = document.getElementById('statusChart').getContext('2d');
        new Chart(statusCtx, {
            type: 'pie',
            data: {
                labels: ['Available', 'Sold', 'Booked'],
                datasets: [{
                    data: [data.cars.available, data.cars.sold, data.cars.booked],
                    backgroundColor: ['#48bb78', '#ed8936', '#4299e1'],
                    borderWidth: 2,
                    borderColor: '#fff'
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'bottom',
                        labels: {
                            padding: 20,
                            font: {
                                size: 12
                            }
                        }
                    }
                },
                layout: {
                    padding: 10
                }
            }
        });
    })
    .catch(error => {
        console.error('Error fetching dashboard stats:', error);
        // Fallback chart with sample data
        const statusCtx = document.getElementById('statusChart').getContext('2d');
        new Chart(statusCtx, {
            type: 'pie',
            data: {
                labels: ['Available', 'Sold', 'Booked'],
                datasets: [{
                    data: [5, 3, 2],
                    backgroundColor: ['#48bb78', '#ed8936', '#4299e1'],
                    borderWidth: 2,
                    borderColor: '#fff'
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'bottom',
                        labels: {
                            padding: 20,
                            font: {
                                size: 12
                            }
                        }
                    }
                },
                layout: {
                    padding: 10
                }
            }
        });
    });
</script>
{% endblock %}